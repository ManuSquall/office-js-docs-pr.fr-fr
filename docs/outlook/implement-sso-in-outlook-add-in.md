---
title: 'Scénario: implémenter l’authentification unique dans votre service'
description: Découvrez comment utiliser le jeton d’authentification unique et le jeton d’identité Exchange fournis par un complément Outlook afin d’implémenter l’authentification unique (SSO) pour votre service.
ms.date: 08/20/2020
localization_priority: Normal
ms.openlocfilehash: 54de99d1857e771453795f5e75ae5ee69bbac6ce
ms.sourcegitcommit: 9609bd5b4982cdaa2ea7637709a78a45835ffb19
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/28/2020
ms.locfileid: "47293904"
---
# <a name="scenario-implement-single-sign-on-to-your-service-in-an-outlook-add-in"></a><span data-ttu-id="c86c4-103">Scénario : Implémenter l’authentification unique sur votre service dans un complément Outlook</span><span class="sxs-lookup"><span data-stu-id="c86c4-103">Scenario: Implement single sign-on to your service in an Outlook add-in</span></span>

<span data-ttu-id="c86c4-104">Dans cet article, nous allons vous expliquer comment utiliser le [jeton d’accès à authentification unique](authenticate-a-user-with-an-sso-token.md) et le [jeton d’identité Exchange](authenticate-a-user-with-an-identity-token.md) pour implémenter une authentification unique sur votre service principal.</span><span class="sxs-lookup"><span data-stu-id="c86c4-104">In this article we'll explore a recommended method of using the [single sign-on access token](authenticate-a-user-with-an-sso-token.md) and the [Exchange identity token](authenticate-a-user-with-an-identity-token.md) together to provide a single-sign on implementation to your own backend service.</span></span> <span data-ttu-id="c86c4-105">En utilisant ces jetons, vous pouvez profiter des avantages du jeton d’accès SSO quand il est disponible, tout en garantissant le fonctionnement de votre complément quand il ne l’est pas, par exemple quand l’utilisateur bascule vers un client qui ne les prend pas en charge , ou quand la boîte aux lettres de l’utilisateur se trouve sur un serveur Exchange local.</span><span class="sxs-lookup"><span data-stu-id="c86c4-105">By using both tokens together, you can take advantage of the benefits of the SSO access token when it is available, while ensuring that your add-in will work when it is not, such as when the user switches to a client that does not support them, or if the user's mailbox is on an on-premises Exchange server.</span></span>

<span data-ttu-id="c86c4-106">Pour voir un exemple de complément qui implémente les idées de cet article, consultez la rubrique relative à l' [authentification unique des compléments Outlook](https://github.com/OfficeDev/Outlook-Add-in-SSO).</span><span class="sxs-lookup"><span data-stu-id="c86c4-106">For a sample add-in that implements the ideas in this article, see [Outlook Add-in SSO](https://github.com/OfficeDev/Outlook-Add-in-SSO).</span></span>


> [!NOTE]
> <span data-ttu-id="c86c4-107">La connexion unique sur API est actuellement prise en charge pour Word, Excel et PowerPoint.</span><span class="sxs-lookup"><span data-stu-id="c86c4-107">The Single Sign-on API is currently supported for Word, Excel, Outlook, and PowerPoint.</span></span> <span data-ttu-id="c86c4-108">Pour plus d’informations sur l’endroit où l’API d’authentification unique est actuellement prise en charge, consultez la rubrique [Ensembles de conditions requises de l’API d’identité](../reference/requirement-sets/identity-api-requirement-sets.md).</span><span class="sxs-lookup"><span data-stu-id="c86c4-108">For more information about where the Single Sign-on API is currently supported, see [IdentityAPI requirement sets](../reference/requirement-sets/identity-api-requirement-sets.md).</span></span>
> <span data-ttu-id="c86c4-109">Si vous utilisez un complément Outlook, veillez à activer l’authentification moderne pour la location d’Office 365.</span><span class="sxs-lookup"><span data-stu-id="c86c4-109">If you are working with an Outlook add-in, be sure to enable Modern Authentication for the Office 365 tenancy.</span></span> <span data-ttu-id="c86c4-110">Pour plus d’informations sur la manière de procéder, consultez la rubrique [Exchange Online : Activation de votre client pour l’authentification moderne](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span><span class="sxs-lookup"><span data-stu-id="c86c4-110">For information about how to do this, see [Exchange Online: How to enable your tenant for modern authentication](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span></span>


## <a name="why-use-the-sso-access-token"></a><span data-ttu-id="c86c4-111">Pourquoi utiliser le jeton d’accès SSO ?</span><span class="sxs-lookup"><span data-stu-id="c86c4-111">Why use the SSO access token?</span></span>

<span data-ttu-id="c86c4-112">Le jeton d’identité Exchange étant demandé dans tous les ensembles de conditions requises de l’API du complément, il peut être tentant d’utiliser uniquement ce jeton.</span><span class="sxs-lookup"><span data-stu-id="c86c4-112">The Exchange identity token is available in all requirement sets of the add-in APIs, so it may be tempting to just rely on this token and ignore the SSO token altogether.</span></span> <span data-ttu-id="c86c4-113">Toutefois, le jeton SSO présente des avantages par rapport au jeton d’identité Exchange, c’est pourquoi nous vous recommandons de l’utiliser quand il est disponible.</span><span class="sxs-lookup"><span data-stu-id="c86c4-113">However, the SSO token offers some advantages over the Exchange identity token which make it the recommended method to use when it is available.</span></span>

- <span data-ttu-id="c86c4-114">Le jeton SSO utilise un format OpenID standard et est émis par Azure,</span><span class="sxs-lookup"><span data-stu-id="c86c4-114">The SSO token uses a standard OpenID format and is issued by Azure.</span></span> <span data-ttu-id="c86c4-115">ce qui simplifie considérablement le processus de validation de ces jetons.</span><span class="sxs-lookup"><span data-stu-id="c86c4-115">This greatly simplifies the process of validating these tokens.</span></span> <span data-ttu-id="c86c4-116">En revanche, les jetons d’identité Exchange utilisent un format personnalisé basé sur la norme JWT (JSON Web Token), ce qui nécessite un travail de personnalisation pour valider ce jeton.</span><span class="sxs-lookup"><span data-stu-id="c86c4-116">In comparison, Exchange identity tokens use a custom format based on the JSON Web Token standard, requiring custom work to validate the token.</span></span>
- <span data-ttu-id="c86c4-117">Le jeton SSO peut être employé par votre service principal pour récupérer un jeton d’accès à Microsoft Graph afin d’éviter à l’utilisateur d’entrer une nouvelle fois ses informations d’identification.</span><span class="sxs-lookup"><span data-stu-id="c86c4-117">The SSO token can be used by your backend to retrieve an access token for Microsoft Graph without the user having to do any additional sign in action.</span></span>
- <span data-ttu-id="c86c4-118">Le jeton SSO fournit des informations d’identité plus riche, comme le nom d’affichage de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="c86c4-118">The SSO token provides richer identity information, such as the user's display name.</span></span>

## <a name="add-in-scenario"></a><span data-ttu-id="c86c4-119">Scénario du complément</span><span class="sxs-lookup"><span data-stu-id="c86c4-119">Add-in scenario</span></span>

<span data-ttu-id="c86c4-120">Prenons l’exemple d’un complément composé d’une interface utilisateur et de scripts (HTML + JavaScript), et de l’API web principale appelée par le complément.</span><span class="sxs-lookup"><span data-stu-id="c86c4-120">For the purposes of this example, consider an add-in that consists of both the add-in UI and scripts (HTML + JavaScript) and a backend Web API that is called by the add-in.</span></span> <span data-ttu-id="c86c4-121">L’API web principale appelle à la fois l’[API Microsoft Graph](/graph/overview) et l’API Contoso Data, une API fictive créée par un tiers.</span><span class="sxs-lookup"><span data-stu-id="c86c4-121">The backend Web API makes calls both to the [Microsoft Graph API](/graph/overview) and the Contoso Data API, a fictional API created by a third party.</span></span> <span data-ttu-id="c86c4-122">Tout comme l’API Microsoft Graph, l’API Contoso Data nécessite une authentification OAuth,</span><span class="sxs-lookup"><span data-stu-id="c86c4-122">Like the Microsoft Graph API, the Contoso Data API requires OAuth authentication.</span></span> <span data-ttu-id="c86c4-123">qui exige que l’API web principale soit capable d’appeler les deux API sans inviter l’utilisateur à renseigner ses informations d’identification après chaque expiration du jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="c86c4-123">The requirement is that the backend Web API should be able to call both APIs without having to prompt the user for their credentials every time an access token expires.</span></span>

<span data-ttu-id="c86c4-124">Pour cela, l’API principale crée une base de données utilisateurs sécurisée.</span><span class="sxs-lookup"><span data-stu-id="c86c4-124">To do this, the backend API creates a secure database of users.</span></span> <span data-ttu-id="c86c4-125">Chaque utilisateur obtient une entrée dans la base de données où l’API principale peut stocker des jetons d’actualisation à durée de vie longue pour l’API Microsoft Graph et l’API Contoso Data.</span><span class="sxs-lookup"><span data-stu-id="c86c4-125">Each user will get an entry in the database where the backend can store long-lived refresh tokens for both the Microsoft Graph API and the Contoso Data API.</span></span> <span data-ttu-id="c86c4-126">Les marques JSON suivantes représentent l’entrée d’un utilisateur dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="c86c4-126">The following JSON markup represents a user's entry in the database.</span></span>

```JSON
{
  "userDisplayName": "...",
  "ssoId": "...",
  "exchangeId": "...",
  "graphRefreshToken": "...",
  "contosoRefreshToken": "..."
}
```

<span data-ttu-id="c86c4-127">Le complément inclut le jeton d’accès SSO (s’il est disponible) ou le jeton d’identité Exchange (si le jeton SSO n’est pas disponible), ainsi que tous les appels passés à l’API web principale.</span><span class="sxs-lookup"><span data-stu-id="c86c4-127">The add-in includes either the SSO access token (if it is available) or the Exchange identity token (if the SSO token is not available) with every call it makes to the backend Web API.</span></span>

### <a name="add-in-startup"></a><span data-ttu-id="c86c4-128">Démarrage du complément</span><span class="sxs-lookup"><span data-stu-id="c86c4-128">Add-in startup</span></span>

1. <span data-ttu-id="c86c4-129">Quand le complément démarre, il envoie une demande à l’API web principale pour déterminer si l’utilisateur est enregistré (c’est-à-dire, s’il est associé à un enregistrement dans la base de données utilisateur) et si l’API dispose de jetons d’actualisation pour Graph et Contoso.</span><span class="sxs-lookup"><span data-stu-id="c86c4-129">When the add-in starts, it sends a request to the backend Web API to determine if the user is registered (i.e. has an associated record in the user database) and that the API has refresh tokens for both Graph and Contoso.</span></span> <span data-ttu-id="c86c4-130">Dans cet appel, le complément inclut le jeton SSO (s’il est disponible) et le jeton d’identité.</span><span class="sxs-lookup"><span data-stu-id="c86c4-130">In this call, the add-in includes both the SSO token (if available) and the identity token.</span></span>

1. <span data-ttu-id="c86c4-131">L’API web utilise les méthodes décrites dans les rubriques [Authentifier un utilisateur avec un jeton d’authentification unique dans un complément Outlook](authenticate-a-user-with-an-sso-token.md) et [Authentifier un utilisateur avec un jeton d’identité pour Exchange](authenticate-a-user-with-an-identity-token.md) pour valider et générer un identificateur unique à partir des deux jetons.</span><span class="sxs-lookup"><span data-stu-id="c86c4-131">The Web API uses the methods in [Authenticate a user with an single-sign-on token in an Outlook add-in](authenticate-a-user-with-an-sso-token.md) and [Authenticate a user with an identity token for Exchange](authenticate-a-user-with-an-identity-token.md) to validate and generate a unique identifier from both tokens.</span></span>

1. <span data-ttu-id="c86c4-132">Si un jeton SSO est fourni, l’API web recherche dans la base de données utilisateur une entrée dont la valeur `ssoId` correspond à l’identificateur unique généré à partir du jeton SSO.</span><span class="sxs-lookup"><span data-stu-id="c86c4-132">If an SSO token was provided, the Web API then queries the user database for an entry that has an `ssoId` value that matches the unique identifier generated from the SSO token.</span></span>
   - <span data-ttu-id="c86c4-133">Si aucune entrée ne correspond, passez à l’étape suivante.</span><span class="sxs-lookup"><span data-stu-id="c86c4-133">If an entry did not exist, continue to the next step.</span></span>
   - <span data-ttu-id="c86c4-134">Si l’API trouve cette entrée, passez à l’étape 5.</span><span class="sxs-lookup"><span data-stu-id="c86c4-134">If an entry exists, proceed to step 5.</span></span>

1. <span data-ttu-id="c86c4-135">L’API web recherche dans la base de données une entrée dont la valeur `exchangeId` correspond à l’identificateur unique généré à partir du jeton d’identité Exchange.</span><span class="sxs-lookup"><span data-stu-id="c86c4-135">The Web API queries the database for an entry that has an `exchangeId` value that matches the unique identifier generated from the Exchange identity token.</span></span>
   - <span data-ttu-id="c86c4-136">Si aucune entrée ne correspond et qu’un jeton SSO a été fourni, mettez à jour l’enregistrement de l’utilisateur dans la base de données pour que la valeur `ssoId` corresponde à l’identificateur unique généré à partir du jeton SSO, puis passez à l’étape 5.</span><span class="sxs-lookup"><span data-stu-id="c86c4-136">If an entry exists and an SSO token was provided, update the user's record in the database to set the `ssoId` value to the unique identifier generated from the SSO token and proceed to step 5.</span></span>
   - <span data-ttu-id="c86c4-137">Si l’API trouve une entrée et qu’aucun jeton SSO n’a été fourni, passez à l’étape 5.</span><span class="sxs-lookup"><span data-stu-id="c86c4-137">If an entry exists and no SSO token was provided, proceed to step 5.</span></span>
   - <span data-ttu-id="c86c4-138">Si aucune entrée ne correspond, créez une entrée.</span><span class="sxs-lookup"><span data-stu-id="c86c4-138">If no entry exists, create a new entry.</span></span> <span data-ttu-id="c86c4-139">Attribuez à la valeur `ssoId` l’identificateur unique généré à partir de jeton SSO (s’il est disponible) et attribuez à la valeur `exchangeId` l’identificateur unique généré à partir du jeton d’identité Exchange.</span><span class="sxs-lookup"><span data-stu-id="c86c4-139">Set `ssoId` to the unique identifier generated from the SSO token (if available), and set `exchangeId` to the unique identifier generated from the Exchange identity token.</span></span>

1. <span data-ttu-id="c86c4-140">Recherchez un jeton d’actualisation valide dans la valeur `graphRefreshToken` de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="c86c4-140">Check for a valid refresh token in the user's `graphRefreshToken` value.</span></span>
   - <span data-ttu-id="c86c4-141">Si la valeur est manquante ou non valide et qu’un jeton SSO a été fourni, utilisez le [flux Pour le compte de Oauth2](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of) pour obtenir un jeton d’accès et un jeton d’actualisation pour Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="c86c4-141">If the value is missing or invalid and an SSO token was provided, use the [OAuth2 On-Behalf-Of flow](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of) to obtain an access token and refresh token for Graph.</span></span> <span data-ttu-id="c86c4-142">Enregistrez le jeton d’actualisation dans la valeur `graphRefreshToken` de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="c86c4-142">Save the refresh token in the `graphRefreshToken` value for the user.</span></span>

1. <span data-ttu-id="c86c4-143">Recherchez les jetons d’actualisation valides dans les valeurs `graphRefreshToken` et `contosoRefreshToken`.</span><span class="sxs-lookup"><span data-stu-id="c86c4-143">Check for valid refresh tokens in both `graphRefreshToken` and `contosoRefreshToken`.</span></span>
   - <span data-ttu-id="c86c4-144">Si ces deux valeurs sont valides, répondez au complément pour indiquer que l’utilisateur est déjà enregistré et configuré.</span><span class="sxs-lookup"><span data-stu-id="c86c4-144">If both values are valid, respond to the add-in to indicate that the user is already registered and configured.</span></span>
   - <span data-ttu-id="c86c4-145">Si l’une de ces valeurs n’est pas valide, répondez au complément pour indiquer que l’utilisateur doit être installé et signaler les services (Graph ou Contoso) à configurer.</span><span class="sxs-lookup"><span data-stu-id="c86c4-145">If either value is invalid, respond to the add-in to indicate that user setup is required, along with which services (Graph or Contoso) need to be configured.</span></span>

1. <span data-ttu-id="c86c4-146">Le complément vérifie la réponse.</span><span class="sxs-lookup"><span data-stu-id="c86c4-146">The add-in checks the response.</span></span>
   - <span data-ttu-id="c86c4-147">Si l’utilisateur est déjà enregistré et configuré, le complément continue de fonctionner normalement.</span><span class="sxs-lookup"><span data-stu-id="c86c4-147">If the user is already registered and configured, the add-in continues with normal operation.</span></span>
   - <span data-ttu-id="c86c4-148">Si l’utilisateur doit être configuré, le complément passe en mode Installation et invite l’utilisateur à autoriser l’accès au complément.</span><span class="sxs-lookup"><span data-stu-id="c86c4-148">If user setup is required, the add-in enters "setup" mode and prompts the user to authorize the add-in.</span></span>

### <a name="authorize-the-backend-web-api"></a><span data-ttu-id="c86c4-149">Autorisation de l’API web principale</span><span class="sxs-lookup"><span data-stu-id="c86c4-149">Authorize the backend Web API</span></span>

<span data-ttu-id="c86c4-150">Dans l’idéal, il conviendrait d’autoriser une seule fois l’API web principale à appeler l’API Microsoft Graph et l’API Contoso Data, pour éviter d’inviter l’utilisateur à se connecter à chaque fois.</span><span class="sxs-lookup"><span data-stu-id="c86c4-150">The procedure for authorizing the backend Web API to call the Microsoft Graph API and Contoso Data API should ideally only have to happen once, to minimize having to prompt the user for sign-in.</span></span>

<span data-ttu-id="c86c4-151">En fonction de la réponse de l’API web principale, le complément doit autoriser l’utilisateur à accéder à l’API Microsoft Graph et/ou à l’API Contoso Data.</span><span class="sxs-lookup"><span data-stu-id="c86c4-151">Based on the response from the backend Web API, the add-in may need to authorize the user for the Microsoft Graph API, the Contoso Data API, or both.</span></span> <span data-ttu-id="c86c4-152">Étant donné que les deux API ont recours à l’authentification OAuth2, la même méthode doit être employée pour les deux.</span><span class="sxs-lookup"><span data-stu-id="c86c4-152">Since both APIs use OAuth2 authentication, the method is similar for both.</span></span>

1. <span data-ttu-id="c86c4-153">Le complément informe l’utilisateur qu’il doit autoriser l’utilisation de l’API et lui demande de cliquer sur un lien ou un bouton pour démarrer la procédure.</span><span class="sxs-lookup"><span data-stu-id="c86c4-153">The add-in notifies the user that it needs them to authorize their use of the API and asks them to click a link or button to start the process.</span></span>

    > [!NOTE]
    > <span data-ttu-id="c86c4-154">L’exemple de complément de l' [authentification unique du complément Outlook](https://github.com/OfficeDev/Outlook-Add-in-SSO) indique comment utiliser l' [API Dialog](/javascript/api/office/office.ui#displaydialogasync-startaddress--options--callback-) et la [bibliothèque Office-js-helpers](https://github.com/OfficeDev/office-js-helpers) comme options pour démarrer le [flux de code d’autorisation OAuth2](/azure/active-directory/develop/active-directory-protocols-oauth-code) pour l’API.</span><span class="sxs-lookup"><span data-stu-id="c86c4-154">The example add-in at [Outlook Add-in SSO](https://github.com/OfficeDev/Outlook-Add-in-SSO) shows how to use the [Dialog API](/javascript/api/office/office.ui#displaydialogasync-startaddress--options--callback-) and the [office-js-helpers library](https://github.com/OfficeDev/office-js-helpers) as options to start the [OAuth2 Authorization Code flow](/azure/active-directory/develop/active-directory-protocols-oauth-code) for the API.</span></span>

1. <span data-ttu-id="c86c4-155">Une fois le flux terminé, le complément envoie le jeton d’actualisation à l’API web principale et inclut le jeton SSO (s’il est disponible) ou le jeton d’identité Exchange.</span><span class="sxs-lookup"><span data-stu-id="c86c4-155">Once the flow completes, the add-in sends the refresh token to the backend Web API and includes the SSO token (if available) or the Exchange identity token.</span></span>

1. <span data-ttu-id="c86c4-156">L’API web principale recherche l’utilisateur dans la base de données et met à jour le jeton d’actualisation approprié.</span><span class="sxs-lookup"><span data-stu-id="c86c4-156">The backend Web API locates the user in the database and updates the appropriate refresh token.</span></span>

1. <span data-ttu-id="c86c4-157">Le complément continue de fonctionner normalement.</span><span class="sxs-lookup"><span data-stu-id="c86c4-157">The add-in continues with normal operation.</span></span>

### <a name="normal-operation"></a><span data-ttu-id="c86c4-158">Conditions normales de fonctionnement</span><span class="sxs-lookup"><span data-stu-id="c86c4-158">Normal operation</span></span>

<span data-ttu-id="c86c4-159">Quand le complément appelle l’API web principale, il inclut le jeton SSO ou le jeton d’identité Exchange.</span><span class="sxs-lookup"><span data-stu-id="c86c4-159">Whenever the add-in calls the backend Web API, it includes either the SSO token or the Exchange identity token.</span></span> <span data-ttu-id="c86c4-160">L’API web principale localise l’utilisateur en fonction de ce jeton, puis utilise les jetons d’actualisation stockés pour obtenir les jetons d’accès à l’API Microsoft Graph et à l’API Contoso Data.</span><span class="sxs-lookup"><span data-stu-id="c86c4-160">The backend Web API locates the user by this token, then uses the stored refresh tokens to obtain access tokens for the Microsoft Graph API and the Contoso Data API.</span></span> <span data-ttu-id="c86c4-161">Tant que les jetons d’actualisation sont valides, l’utilisateur n’a pas besoin de se reconnecter.</span><span class="sxs-lookup"><span data-stu-id="c86c4-161">As long as the refresh tokens are valid, the user will not have to sign in again.</span></span>
